# Example Home Assistant config for the simplified PIS add-on payload
# Drop this into your configuration.yaml (adjust host/port as needed).

rest:
  - resource: http://127.0.0.1:8080/data
    method: GET
    timeout: 30
    scan_interval: 3600  # once per hour; the add-on caches for a day by default
    verify_ssl: false
    name: pis_portal
    value_template: "{{ value_json.status.state }}"
    json_attributes:
      - finance
      - consumption
      - period
      - cache

# Template sensors that read from sensor.pis_portal attributes

template:
  - sensor:
      # Is there anything outstanding and how much?
      - name: "PIS stanje"
        unique_id: pis_finance_status
        icon: mdi:scale-balance
        state: >
          {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
          {{ finance.get('status', 'unknown') }}
        attributes:
          dug: >
            {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
            {{ finance.get('outstanding') | float(0) | round(2) }}
          neplaceno_racuna: >
            {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
            {% set unpaid = finance.get('unpaid') or {} %}
            {{ unpaid.get('count', 0) }}
          neplaceno_ukupno: >
            {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
            {% set unpaid = finance.get('unpaid') or {} %}
            {{ unpaid.get('total') | float(0) | round(2) }}

      # Latest invoice basics
      - name: "PIS zadnji račun iznos"
        unique_id: pis_last_invoice_amount
        icon: mdi:receipt-text
        unit_of_measurement: "€"
        state: >
          {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
          {% set invoice = finance.get('latest_invoice') or {} %}
          {{ invoice.get('amount') | float(0) | round(2) }}
        attributes:
          broj: >
            {% set finance = state_attr('sensor.pis_portal', 'finance') or {} %}
            {% set invoice = finance.get('latest_invoice') or {} %}
            {{ invoice.get('number') }}
          datum_izdavanja: >
            {% set invoice = (state_attr('sensor.pis_portal', 'finance') or {}).get('latest_invoice') or {} %}
            {{ invoice.get('issue_date') or invoice.get('issue_date_raw') }}
          datum_valute: >
            {% set invoice = (state_attr('sensor.pis_portal', 'finance') or {}).get('latest_invoice') or {} %}
            {{ invoice.get('due_date') or invoice.get('due_date_raw') }}

      # Usage and approximate cost (gas used * 0.55)
      - name: "PIS potrošnja zadnje razdoblje"
        unique_id: pis_usage_last_period
        icon: mdi:fire
        unit_of_measurement: "m³"  # adjust if your portal uses kWh instead
        state: >
          {% set consumption = state_attr('sensor.pis_portal', 'consumption') or {} %}
          {{ consumption.get('usage') | float(0) | round(2) }}
        attributes:
          dana_izmedu_ocitanja: >
            {% set consumption = state_attr('sensor.pis_portal', 'consumption') or {} %}
            {{ consumption.get('days_between_readings') }}
          prosjecno_dnevno: >
            {% set consumption = state_attr('sensor.pis_portal', 'consumption') or {} %}
            {{ consumption.get('avg_daily_usage') | float(0) | round(2) }}
          zadnje_ocitanje_prije_dana: >
            {% set consumption = state_attr('sensor.pis_portal', 'consumption') or {} %}
            {{ consumption.get('days_since_last_reading') }}
          iznos_procijenjen: >
            {% set consumption = state_attr('sensor.pis_portal', 'consumption') or {} %}
            {{ consumption.get('approx_last_period_cost') | float(0) | round(2) }}
